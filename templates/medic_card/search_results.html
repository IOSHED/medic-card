<!-- medic_card/templates/medic_card/search_results.html -->
{% extends 'base.html' %}
{% load static %}
{% load favorites_tags %}

{% block extra_css %}
<style>
    .autocomplete-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .autocomplete-suggestion {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }

    .autocomplete-suggestion:hover {
        background-color: #f8f9fa;
    }

    .autocomplete-suggestion:last-child {
        border-bottom: none;
    }

    .suggestion-type {
        font-size: 0.8em;
        color: #6c757d;
        text-transform: uppercase;
    }

    .search-container {
        position: relative;
    }

    /* Стили для модального окна поиска на мобильных */
    #searchModal .autocomplete-suggestions {
        position: relative;
        margin-top: 5px;
    }

    .search-section {
        margin-bottom: 3rem;
    }

    .search-section-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
        color: #495057;
    }

    .no-results {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }

    .no-results i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Результаты поиска</h2>

    <!-- Форма поиска -->
    <div class="row mb-4">
        <div class="col-md-8">
            <form method="get" action="{% url 'medic_card:search' %}" id="search-form">
                <div class="input-group input-group-lg">
                    <input type="text" class="form-control" name="q"
                           value="{{ query }}" placeholder="Поиск по темам, билетам, вопросам..."
                           id="search-input" autocomplete="off">
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-search"></i> Найти
                    </button>
                </div>
                <div class="autocomplete-suggestions" id="autocomplete-results"></div>
            </form>
            {% if query %}
            {% if results.questions %}
            <div class="mt-2 text-muted">
                Найдено результатов:
                <span class="badge bg-primary">
                {% firstof results.themes|length 0 as theme_count %}
                {% firstof results.tickets|length 0 as ticket_count %}
                {% firstof results.questions|length 0 as question_count %}
                {{ theme_count|add:ticket_count|add:question_count }}
                </span>
<!--                <span class="badge bg-primary">{{ results.themes|length|add:results.tickets|length|add:results.questions|length }}</span>-->
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>

    {% if query %}
    {% if has_results %}
    <!-- Результаты поиска по темам -->
    {% if results.themes %}
    <div class="search-section">
        <h3 class="search-section-title">
            <i class="bi bi-folder me-2"></i>Темы ({{ results.themes|length }})
        </h3>
        <div class="row">
            {% for theme in results.themes %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 shadow-sm border-{{ theme|get_progress_color:user }}">
                    <div class="card-body d-flex flex-column position-relative">
                        <!-- Иконка звездочки -->
                        {% if user.is_authenticated %}
                        <button class="btn btn-link p-0 position-absolute top-0 end-0 me-2 mt-2 favorite-btn"
                                data-content-type-id="{{ theme|content_type_id }}"
                                data-object-id="{{ theme.id }}"
                                title="{% if theme|is_favorite:user %}Удалить из избранного{% else %}Добавить в избранное{% endif %}">
                            <i class="bi bi-star{% if theme|is_favorite:user %}-fill text-warning{% else %} text-muted{% endif %} fs-5"></i>
                        </button>
                        {% endif %}

                        <h5 class="card-title">{{ theme.title }}</h5>
                        {% if theme.description %}
                        <p class="card-text text-muted flex-grow-1">{{ theme.description|truncatewords:20 }}</p>
                        {% endif %}
                        <div class="mt-auto">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <small class="text-muted">
                                    <i class="bi bi-ticket-perforated"></i> {{ theme.get_tickets_count }} билетов
                                </small>
                                <small class="text-muted">{{ theme.created_at|date:"d.m.Y" }}</small>
                            </div>
                            {% if user.is_authenticated %}
                            {% with stats=theme|get_progress_stats:user %}
                            {% if stats and stats.total_questions > 0 %}
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Прогресс:</small>
                                    <small class="fw-bold text-{{ theme|get_progress_color:user }}">
                                        {{ stats.correct_answers }}/{{ stats.total_questions }}
                                        ({{ stats.accuracy|floatformat:1 }}%)
                                    </small>
                                </div>
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-{{ theme|get_progress_color:user }}"
                                         style="width: {{ stats.accuracy }}%"></div>
                                </div>
                                {% if stats.mistakes > 0 %}
                                <small class="text-danger">
                                    <i class="bi bi-x-circle"></i> {{ stats.mistakes }} ошибок
                                </small>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% endwith %}
                            {% endif %}
                            <a href="{% url 'medic_card:theme_detail' theme.id %}" class="btn btn-primary w-100">
                                Перейти к теме
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Результаты поиска по билетам -->
    {% if results.tickets %}
    <div class="search-section">
        <h3 class="search-section-title">
            <i class="bi bi-ticket-perforated me-2"></i>Билеты ({{ results.tickets|length }})
        </h3>
        <div class="row">
            {% for ticket in results.tickets %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 shadow-sm border-{{ ticket|get_progress_color:user }}">
                    <div class="card-body d-flex flex-column position-relative">
                        <!-- Иконка звездочки -->
                        {% if user.is_authenticated %}
                        <button class="btn btn-link p-0 position-absolute top-0 end-0 me-2 mt-2 favorite-btn"
                                data-content-type-id="{{ ticket|content_type_id }}"
                                data-object-id="{{ ticket.id }}"
                                title="{% if ticket|is_favorite:user %}Удалить из избранного{% else %}Добавить в избранное{% endif %}">
                            <i class="bi bi-star{% if ticket|is_favorite:user %}-fill text-warning{% else %} text-muted{% endif %} fs-5"></i>
                        </button>
                        {% endif %}

                        <h5 class="card-title">{{ ticket.title }}</h5>
                        {% if ticket.description %}
                        <p class="card-text text-muted flex-grow-1">{{ ticket.description|truncatewords:15 }}</p>
                        {% endif %}
                        <div class="mt-auto">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <small class="text-muted">
                                    <i class="bi bi-question-circle"></i> {{ ticket.get_questions_count }} вопросов
                                </small>
                                <small class="text-muted">{{ ticket.created_at|date:"d.m.Y" }}</small>
                            </div>
                            {% if user.is_authenticated %}
                            {% with stats=ticket|get_progress_stats:user %}
                            {% if stats and stats.total_questions > 0 %}
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Прогресс:</small>
                                    <small class="fw-bold text-{{ ticket|get_progress_color:user }}">
                                        {{ stats.correct_answers }}/{{ stats.total_questions }}
                                        ({{ stats.accuracy|floatformat:1 }}%)
                                    </small>
                                </div>
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar bg-{{ ticket|get_progress_color:user }}"
                                         style="width: {{ stats.accuracy }}%"></div>
                                </div>
                                {% if stats.mistakes > 0 %}
                                <small class="text-danger">
                                    <i class="bi bi-x-circle"></i> {{ stats.mistakes }} ошибок
                                </small>
                                {% endif %}
                                {% if stats.is_completed %}
                                <small class="text-success">
                                    <i class="bi bi-check-circle"></i> Завершен
                                </small>
                                {% else %}
                                <small class="text-info">
                                    <i class="bi bi-clock"></i> В процессе
                                </small>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% endwith %}
                            {% endif %}
                            <a href="{% url 'medic_card:ticket_detail' ticket.id %}" class="btn btn-primary w-100">
                                Начать билет
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Результаты поиска по вопросам -->
    {% if results.questions %}
    <div class="search-section">
        <h3 class="search-section-title">
            <i class="bi bi-question-circle me-2"></i>Вопросы ({{ results.questions|length }})
        </h3>
        <div class="row">
            {% for question in results.questions %}
            <div class="col-12 mb-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h5 class="card-title mb-2">
                                    Вопрос {{ forloop.counter }}
                                </h5>
                                <p class="card-text mb-3">{{ question.text|truncatewords:30 }}</p>
                                {% if question.image %}
                                <div class="mb-3">
                                    <img src="{{ question.image.url }}" alt="Изображение к вопросу" class="img-thumbnail" style="max-width: 200px; max-height: 150px;">
                                </div>
                                {% endif %}
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="bi bi-check-circle"></i> {{ question.get_answers_count }} вариантов ответа
                                    </small>
                                    <small class="text-muted">{{ question.created_at|date:"d.m.Y" }}</small>
                                </div>
                            </div>
                            <div class="ms-3">
                                <a href="{% url 'medic_card:question_detail' question.id %}" class="btn btn-outline-primary">
                                    Открыть вопрос
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Нет результатов -->
    <div class="no-results">
        <i class="bi bi-search"></i>
        <h4>Ничего не найдено</h4>
        <p>Попробуйте изменить поисковый запрос или использовать другие ключевые слова.</p>
    </div>
    {% endif %}
    {% else %}
    <!-- Пустой запрос -->
    <div class="no-results">
        <i class="bi bi-chat-square-text"></i>
        <h4>Запрос</h4>
        <p>Найдите темы, билеты или вопросы по ключевым словам.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // JavaScript для автодополнения (если нужно)
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search-input');
        const autocompleteResults = document.getElementById('autocomplete-results');

        if (searchInput && autocompleteResults) {
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();

                if (query.length < 2) {
                    autocompleteResults.style.display = 'none';
                    return;
                }

                // Здесь можно добавить AJAX-запрос для автодополнения
                // Пока просто скрываем, если не реализовано
                autocompleteResults.style.display = 'none';
            });

            // Скрываем автодополнение при клике вне поля
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !autocompleteResults.contains(e.target)) {
                    autocompleteResults.style.display = 'none';
                }
            });
        }
    });
</script>

<!--<script>-->
<!--    document.addEventListener('DOMContentLoaded', function() {-->
<!--        const searchInput = document.getElementById('search-input');-->
<!--        const autocompleteResults = document.getElementById('autocomplete-results');-->
<!--        let currentRequest = null;-->

<!--        if (searchInput && autocompleteResults) {-->
<!--            searchInput.addEventListener('input', function() {-->
<!--                const query = this.value.trim();-->

<!--                // Отменяем предыдущий запрос-->
<!--                if (currentRequest) {-->
<!--                    currentRequest.abort();-->
<!--                }-->

<!--                if (query.length < 2) {-->
<!--                    autocompleteResults.style.display = 'none';-->
<!--                    return;-->
<!--                }-->

<!--                // Показываем индикатор загрузки-->
<!--                autocompleteResults.innerHTML = '<div class="autocomplete-suggestion">Поиск...</div>';-->
<!--                autocompleteResults.style.display = 'block';-->

<!--                // Создаем новый запрос-->
<!--                currentRequest = new XMLHttpRequest();-->
<!--                currentRequest.open('GET', `{% url 'medic_card:search_autocomplete' %}?q=${encodeURIComponent(query)}`);-->
<!--                currentRequest.setRequestHeader('X-Requested-With', 'XMLHttpRequest');-->

<!--                currentRequest.onload = function() {-->
<!--                    if (currentRequest.status === 200) {-->
<!--                        const data = JSON.parse(currentRequest.responseText);-->
<!--                        displayAutocompleteResults(data.results);-->
<!--                    }-->
<!--                    currentRequest = null;-->
<!--                };-->

<!--                currentRequest.onerror = function() {-->
<!--                    autocompleteResults.style.display = 'none';-->
<!--                    currentRequest = null;-->
<!--                };-->

<!--                currentRequest.send();-->
<!--            });-->

<!--            // Скрываем автодополнение при клике вне поля-->
<!--            document.addEventListener('click', function(e) {-->
<!--                if (!searchInput.contains(e.target) && !autocompleteResults.contains(e.target)) {-->
<!--                    autocompleteResults.style.display = 'none';-->
<!--                }-->
<!--            });-->

<!--            // Обработка выбора варианта автодополнения-->
<!--            autocompleteResults.addEventListener('click', function(e) {-->
<!--                const suggestion = e.target.closest('.autocomplete-suggestion');-->
<!--                if (suggestion) {-->
<!--                    const url = suggestion.dataset.url;-->
<!--                    if (url) {-->
<!--                        window.location.href = url;-->
<!--                    }-->
<!--                }-->
<!--            });-->

<!--            function displayAutocompleteResults(results) {-->
<!--                if (results.length === 0) {-->
<!--                    autocompleteResults.innerHTML = '<div class="autocomplete-suggestion">Ничего не найдено</div>';-->
<!--                    autocompleteResults.style.display = 'block';-->
<!--                    return;-->
<!--                }-->

<!--                autocompleteResults.innerHTML = '';-->
<!--                results.forEach(result => {-->
<!--                    const div = document.createElement('div');-->
<!--                    div.className = 'autocomplete-suggestion';-->
<!--                    div.dataset.url = result.url;-->

<!--                    let typeText = '';-->
<!--                    switch(result.type) {-->
<!--                        case 'theme': typeText = 'Тема'; break;-->
<!--                        case 'ticket': typeText = 'Билет'; break;-->
<!--                        case 'question': typeText = 'Вопрос'; break;-->
<!--                    }-->

<!--                    div.innerHTML = `-->
<!--                    <div class="d-flex justify-content-between align-items-start">-->
<!--                        <div>-->
<!--                            <strong>${result.title}</strong>-->
<!--                            ${result.description ? `<br><small class="text-muted">${result.description}</small>` : ''}-->
<!--                        </div>-->
<!--                        <span class="badge bg-secondary suggestion-type">${typeText}</span>-->
<!--                    </div>-->
<!--                `;-->
<!--                    autocompleteResults.appendChild(div);-->
<!--                });-->
<!--                autocompleteResults.style.display = 'block';-->
<!--            }-->
<!--        }-->

<!--        // Инициализация для модального окна поиска на мобильных-->
<!--        const mobileSearchInput = document.getElementById('mobile-search-input');-->
<!--        const mobileAutocomplete = document.getElementById('mobile-autocomplete-results');-->

<!--        if (mobileSearchInput && mobileAutocomplete) {-->
<!--            // Аналогичный код для мобильного поиска-->
<!--            // Можно вынести в функцию для избежания дублирования-->
<!--        }-->
<!--    });-->
<!--</script>-->
{% endblock %}